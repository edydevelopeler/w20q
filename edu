#!/bin/sh
# --- LOKASI FILE KONFIGURASI ---
CONFIG_FILE="/etc/config/edu_config.conf"

# --- KONFIGURASI API CEK KUOTA ---
API_URL_CEK_KUOTA="https://apigw.kmsp-store.com/sidompul/v4/cek_kuota"

# --- FUNGSI UNTUK KONFIGURASI AWAL ---
setup_credentials() {
    # Buat direktori jika belum ada
    mkdir -p "$(dirname "$CONFIG_FILE")"
    if [ ! -f "$CONFIG_FILE" ]; then
        echo "--- Pengaturan Awal Diperlukan ---"
        printf "Masukkan BOT_TOKEN: "
        read BOT_TOKEN
        printf "Masukkan CHAT_ID: "
        read CHAT_ID
        printf "Masukkan Nomor HP untuk Cek Kuota (contoh: 081xxxx): "
        read MSISDN
        printf "Masukkan AMBANG BATAS KUOTA dalam GB (contoh: 1): "
        read QUOTA_THRESHOLD

        echo "BOT_TOKEN='${BOT_TOKEN}'" > "$CONFIG_FILE"
        echo "CHAT_ID='${CHAT_ID}'" >> "$CONFIG_FILE"
        echo "MSISDN='${MSISDN}'" >> "$CONFIG_FILE"
        echo "QUOTA_THRESHOLD='${QUOTA_THRESHOLD}'" >> "$CONFIG_FILE"
        echo "Konfigurasi berhasil disimpan."
    fi
    . "$CONFIG_FILE"
}

# --- FUNGSI UNTUK MENGIRIM NOTIFIKASI TELEGRAM ---
send_telegram_notification() {
    MESSAGE="$1"
    if [ -z "$MESSAGE" ]; then return; fi
    URL="https://api.telegram.org/bot${BOT_TOKEN}/sendMessage"
    curl -s -X POST "$URL" -d chat_id="$CHAT_ID" --data-urlencode "text=$MESSAGE" -d parse_mode="Markdown" > /dev/null
}

# --- FUNGSI PENGECEKAN KUOTA ---
check_quota_via_api() {
    echo "[1/4] Mengecek sisa kuota via API..."
    REQUEST_URL="${API_URL_CEK_KUOTA}?msisdn=${MSISDN}&isJSON=true"
    API_RESPONSE=$(curl -s -X GET "${REQUEST_URL}" -H 'Authorization: Basic c2lkb21wdWxhcGk6YXBpZ3drbXNw' -H 'X-API-Key: 60ef29aa-a648-4668-90ae-20951ef90c55' -H 'X-App-Version: 4.0.0')
    RESULT_STRING=$(echo "$API_RESPONSE" | jq -r '.data.hasil // "null"')
    
    if echo "$RESULT_STRING" | grep -q "batas maksimal pengecekan"; then
        echo "-> API Rate Limit terdeteksi. Skrip dihentikan sementara."
        send_telegram_notification "⏳ *Pengecekan Kuota Dijeda*

API memberlakukan batas pengecekan. Skrip akan mencoba lagi pada jadwal berikutnya."
        exit 0
    fi

    REMAINING_QUOTA_GB=$(echo "$RESULT_STRING" | sed -n -r 's/.*Sisa Kuota: ([0-9]+\.?[0-9]*)\s*GB.*/\1/pI')
    
    if [ -z "$REMAINING_QUOTA_GB" ]; then
        echo "-> Format kuota tidak dikenali. Skrip berhenti."
        send_telegram_notification "❓ *Info Kuota Tidak Dikenali*

API berhasil merespons, tetapi format kuota tidak dapat dibaca: \`$RESULT_STRING\`"
        exit 1
    fi

    echo "-> Sisa kuota terdeteksi: $REMAINING_QUOTA_GB GB"
    if [ $(echo "$REMAINING_QUOTA_GB <= $QUOTA_THRESHOLD" | bc) -eq 1 ]; then
        echo "-> KUOTA RENDAH! Melanjutkan proses pembelian paket."
        send_telegram_notification "⚠️ *Peringatan Kuota Rendah*

Sisa kuota terdeteksi: *${REMAINING_QUOTA_GB} GB*. Memulai proses pembelian paket baru."
        return 0
    else
        echo "-> Kuota masih cukup ($REMAINING_QUOTA_GB GB). Skrip dihentikan."
        exit 0
    fi
}

# --- FUNGSI UTAMA ---
main() {
    echo "=============================================="
    echo "Memulai skrip otomatisasi pada $(date)"
    
    # --- LOGIKA KUNCI DI SINI ---
    # Cek apakah argumen --force diberikan
    if [ "$1" = "--force" ]; then
        echo "-> Mode darurat diaktifkan (dipanggil oleh ping monitor)."
        echo "-> Melewati pengecekan kuota API dan langsung membeli paket."
        send_telegram_notification "🚨 *Koneksi Terputus!*

Ping gagal. Mencoba membeli paket baru secara darurat."
    else
        # Perilaku normal (dipanggil oleh cron)
        check_quota_via_api
    fi
    
    STOP_MSG=""
    BUY_MSG=""

    echo "[2/4] Menjalankan perintah ADB untuk STOP paket..."
    adb shell am start -a android.intent.action.CALL -d "tel:*808*5*2*1*1%23" && sleep 20 && adb shell input keyevent 4
    if [ $? -eq 0 ]; then
        STOP_MSG=$(printf "✅ Stop Paket BERHASIL!\\n\\nDate : \`%s\`" "$(date +"%d %B %Y, %I:%M:%S %p")")
    else
        exit 1
    fi
    
    sleep 10

    echo "[3/4] Menjalankan perintah ADB untuk BELI paket..."
    adb shell am start -a android.intent.action.CALL -d "tel:*808*4*1*1*1%23" && sleep 15 && adb shell input keyevent 4
    if [ $? -eq 0 ]; then
        BUY_MSG=$(printf "✅ Beli Paket BERHASIL!\\n\\nDate : \`%s\`" "$(date +"%d %B %Y, %I:%M:%S %p")")
    fi

    sleep 3

    echo "[4/4] Mengaktifkan/menonaktifkan mode pesawat..."
    adb shell cmd connectivity airplane-mode enable && sleep 3 && adb shell cmd connectivity airplane-mode disable
    
    echo "Menunggu 15 detik agar koneksi internet stabil..."
    sleep 15
    
    FINAL_MESSAGE=""
    if [ -n "$STOP_MSG" ]; then FINAL_MESSAGE="$STOP_MSG"; fi
    if [ -n "$BUY_MSG" ]; then
        if [ -n "$FINAL_MESSAGE" ]; then
            FINAL_MESSAGE=$(printf "%s\\n\\n---\\n" "$FINAL_MESSAGE")
        fi
        FINAL_MESSAGE="$FINAL_MESSAGE$BUY_MSG"
    fi

    send_telegram_notification "$FINAL_MESSAGE"
    echo "Skrip selesai dieksekusi."
}

# --- Dependensi ---
# opkg install curl coreutils-date adb jq bc

# --- EKSEKUSI SKRIP ---
setup_credentials
# Panggil fungsi utama dengan semua argumen yang diberikan
main "$@"
